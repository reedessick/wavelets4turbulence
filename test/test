#!/bin/bash

# test basic workflows
# Reed Essick (reed.essick@gmail.com)

#-------------------------------------------------

FLOW="M05MA10"
SNAP="0050"

#------------------------

OUTDIR="../data/${FLOW}"
TAG="${FLOW}_${SNAP}"

#---

FLASH="${OUTDIR}/Turb_hdf5_plt_cnt_${SNAP}"

BASE="${OUTDIR}/${TAG}"

#-------------------------------------------------

# convert the file format on disk to be faster to load

echo \
w4t-convert-flash \
    ${FLASH} \
    ${BASE}.hdf \
    vel vort mag curr dens \
    --Verbose \
|| exit 1

#------------------------

# compute structure function

echo \
w4t-structure-function \
    ${BASE}.hdf \
    ${BASE}-structure-function.hdf \
    vel \
    --component 0 \
    --max-edgelength 512 \
    --index 1 2 3 4 \
    --Verbose \
|| exit 1

#------------------------

# denoise to identify coherent structures

echo \
w4t-denoise \
    ${BASE}.hdf \
    ${BASE}-denoise.hdf \
    vel \
    --component 0 \
    --max-edgelength 512 \
    --wavelet haar \
    --threshold 2.0 \
    --max-scale 256 \
    --verbose \
|| exit 1

#-----------

# compute structure function of denoised flow

echo \
w4t-structure-function \
    ${BASE}-denoise.hdf \
    ${BASE}-denoise-structure-function.hdf \
    vel_0 \
    --max-edgelength 512 \
    --index 1 2 3 4 \
    --Verbose \
|| exit 1

#-----------

# identify structures as separate sets of pixels

echo \
w4t-structures \
    ${BASE}-denoise.hdf \
    ${BASE}-denoise-structures.hdf \
    vel_0 \
    --wavelet haar \
    --max-edgelength 256 \
    --threshold 3.0 \
    --num-proc 4 \
    --verbose \
|| exit 1

#------------------------

# denoise to remove coherent structures

echo \
w4t-denoise \
    ${BASE}.hdf \
    ${BASE}-smooth.hdf \
    vel \
    --component 0 \
    --max-edgelength 512 \
    --wavelet haar \
    --threshold 2.0 \
    --smooth \
    --max-scale 256 \
    --verbose \
|| exit 1

#-----------

# compute structure function of smoothed flow

echo \
w4t-structure-function \
    ${BASE}-smooth.hdf \
    ${BASE}-smooth-structure-function.hdf \
    vel_0 \
    --max-edgelength 512 \
    --index 1 2 3 4 \
    --Verbose \
|| exit 1

#-------------------------------------------------

# plot the structure functions

#echo \
w4t-plot-structure-function \
    --source    'full'    ${BASE}-structure-function.hdf \
    --linestyle 'full'    'solid' \
    --marker    'full'    'o' \
    --source    'denoise' ${BASE}-denoise-structure-function.hdf \
    --linestyle 'denoise' 'dashed' \
    --marker    'denoise' 's' \
    --source    'smooth'  ${BASE}-smooth-structure-function.hdf \
    --linestyle 'smooth' 'dotted' \
    --marker    'smooth' '^' \
    --output-dir $OUTDIR \
    --tag $TAG \
    --Verbose \
|| exit 1

#    --rescale \
